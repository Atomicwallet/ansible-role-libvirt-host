---
- name: Ensure libvirt dir storage pool directories exist
  file:
    path: "{{ item.path }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode|int(base=8) }}"
    state: directory
  when: item.type == "dir"
  with_items: "{{ libvirt_host_pools }}"
  become: True

- name: Ensure libvirt lvm2 storage pool directories exist
  lvg:
    vg: "{{ item.source }}"
    pvs: "{{ item.pvs }}"
  when: item.type == "lvm2"
  with_items: "{{ libvirt_host_pools }}"
  become: True

- name: Ensure libvirt storage pools are defined
  virt_pool:
    name: "{{ item.name }}"
    command: define
    xml: "{{ item.xml | default(lookup('template', 'pool.xml.j2')) }}"
    uri: "{{ libvirt_host_uri | default(omit, true) }}"
  with_items: "{{ libvirt_host_pools }}"
  become: True

- name: Ensure libvirt storage pools are active
  virt_pool:
    name: "{{ item.name }}"
    state: active
    uri: "{{ libvirt_host_uri | default(omit, true) }}"
  with_items: "{{ libvirt_host_pools }}"
  become: True

- name: Ensure libvirt storage pools are started on boot
  virt_pool:
    name: "{{ item.name }}"
    autostart: yes
    uri: "{{ libvirt_host_uri | default(omit, true) }}"
  with_items: "{{ libvirt_host_pools }}"
  become: True

- name: "Create custom fact directory"
  file:
    path: "/etc/ansible/facts.d"
    state: "directory"  
  when: item.type == "zfs"
  with_items: "{{ libvirt_host_pools }}"
  become: True  

- name: Create Ansible fact for zfs pool to path mapping
  ini_file:
    path: /etc/ansible/facts.d/zfs-pool.fact
    section: null
    option: "{{ item.name }}"
    value: "{{ item.source }}"
  when: item.type == "zfs"
  with_items: "{{ libvirt_host_pools }}"
  become: True

- name: reload facts
  setup: ~  